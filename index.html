<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENATEDU - Sistema de Gest√£o Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background-color: #dcfce7; color: #166534; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <div id="app"></div>

    <script>
        // ==================== CONFIGURA√á√ÉO FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyChnKOxAQH9RqSYmvcf3zYmajg3p5LCogc",
            authDomain: "educloud-sistema.firebaseapp.com",
            projectId: "educloud-sistema",
            storageBucket: "educloud-sistema.firebasestorage.app",
            messagingSenderId: "279645366191",
            appId: "1:279645366191:web:df16df577ccc959a4f315a"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const app = {
            currentUser: null,
            currentUserData: null,
            currentView: 'dashboard',
            currentMaterialType: 'arquivo',
            
            init() {
                this.monitorAuth();
            },

            monitorAuth() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const doc = await db.collection('users').doc(user.uid).get();
                            if (doc.exists) {
                                this.currentUser = user;
                                this.currentUserData = { id: user.uid, ...doc.data() };
                                this.renderMainLayout();
                            } else {
                                auth.signOut();
                            }
                        } catch (e) {
                            console.error("Erro auth", e);
                            this.renderLogin();
                        }
                    } else {
                        this.renderLogin();
                    }
                });
            },

            // ==================== LOGIN & LAYOUT ====================

            renderLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-800 via-blue-600 to-blue-500 p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 space-y-6 fade-in">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-700 to-blue-500 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
                                    <i class="fas fa-graduation-cap text-3xl text-white"></i>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-900">SENATEDU</h1>
                                <p class="text-gray-500">Sistema de Gest√£o Escolar</p>
                            </div>
                            
                            <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center"></div>
                            
                            <form id="login-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin@escola.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                    <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <button type="submit" id="login-btn" class="w-full bg-blue-700 text-white py-2 rounded-lg font-semibold hover:bg-blue-800 transition">
                                    <span id="btn-text">Entrar</span>
                                </button>
                            </form>
                            <div class="text-center text-sm">
                                <button onclick="app.setupFirstAdmin()" class="text-blue-600 hover:underline font-medium">Criar conta de Administrador</button>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const btnText = document.getElementById('btn-text');
                    
                    btnText.innerHTML = '<div class="loading"></div>';
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                    } catch (err) {
                        document.getElementById('login-error').textContent = 'Email ou senha incorretos';
                        document.getElementById('login-error').classList.remove('hidden');
                        btnText.textContent = 'Entrar';
                    }
                });
            },

            async setupFirstAdmin() {
                const nome = prompt('Digite seu nome completo:');
                const email = prompt('Digite seu email (ser√° o login):');
                const senha = prompt('Crie uma senha (m√≠nimo 6 caracteres):');
                
                if (!nome || !email || !senha) return;
                if (senha.length < 6) { alert('A senha deve ter pelo menos 6 caracteres'); return; }
                
                try {
                    const userCred = await auth.createUserWithEmailAndPassword(email, senha);
                    await db.collection('users').doc(userCred.user.uid).set({
                        nome: nome,
                        email: email,
                        tipo: 'admin',
                        criado: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Administrador criado com sucesso!');
                } catch (err) { alert('Erro: ' + err.message); }
            },

            logout() { auth.signOut(); },

            renderMainLayout() {
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = `
                    <div class="min-h-screen flex flex-col md:flex-row">
                        <aside id="sidebar" class="bg-slate-900 text-white w-64 flex-shrink-0 fixed h-screen overflow-y-auto z-30 hidden md:block">
                            <div class="p-6 border-b border-slate-800">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-400 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-graduation-cap text-lg"></i>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold">SENATEDU</h1>
                                        <p class="text-xs text-slate-400">${this.capitalize(this.currentUserData.tipo)}</p>
                                    </div>
                                </div>
                            </div>
                            <nav class="p-4 space-y-2" id="sidebar-nav"></nav>
                            <div class="absolute bottom-0 w-full p-4 border-t border-slate-800 bg-slate-900">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-sm font-bold">
                                        ${this.currentUserData.nome.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium truncate">${this.currentUserData.nome}</p>
                                        <p class="text-xs text-slate-400 truncate">${this.currentUserData.email}</p>
                                    </div>
                                </div>
                                <button onclick="app.logout()" class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition text-sm">
                                    <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
                                </button>
                            </div>
                        </aside>

                        <main class="flex-1 md:ml-64 min-h-screen">
                            <div class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-10">
                                <button onclick="document.getElementById('sidebar').classList.toggle('hidden')" class="text-gray-600">
                                    <i class="fas fa-bars text-xl"></i>
                                </button>
                                <span class="font-semibold text-blue-800">SENATEDU</span>
                                <div class="w-8"></div>
                            </div>
                            <div id="content-area" class="p-4 md:p-8 fade-in"></div>
                        </main>
                    </div>
                `;

                this.renderSidebar();
                this.renderContent();
            },

            renderSidebar() {
                const nav = document.getElementById('sidebar-nav');
                const type = this.currentUserData.tipo;
                
                const menus = {
                    admin: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'turmas', icon: 'fa-chalkboard', label: 'Turmas' },
                        { id: 'professores', icon: 'fa-chalkboard-teacher', label: 'Professores' }, 
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Alunos' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' }
                    ],
                    professor: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Meus Alunos' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' }
                    ],
                    aluno: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' },
                        { id: 'provas', icon: 'fa-file-signature', label: 'Provas' }
                    ]
                };

                const items = menus[type] || [];
                nav.innerHTML = items.map(item => `
                    <button onclick="app.navigate('${item.id}')" 
                        class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition ${this.currentView === item.id ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                        <i class="fas ${item.icon} w-5"></i>
                        <span>${item.label}</span>
                    </button>
                `).join('');
            },

            navigate(view) {
                this.currentView = view;
                this.renderSidebar();
                this.renderContent();
                if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            },

            async renderContent() {
                const content = document.getElementById('content-area');
                content.innerHTML = '<div class="flex justify-center mt-10"><div class="loading border-blue-600 border-t-transparent w-10 h-10 border-4"></div></div>';

                if (this.currentView === 'dashboard') {
                    await this.renderDashboard(content);
                } else if (this.currentView === 'materiais') {
                    await this.renderMateriais(content);
                } else if (this.currentView === 'turmas' && this.currentUserData.tipo === 'admin') {
                    await this.renderTurmas(content);
                } else if (this.currentView === 'professores' && this.currentUserData.tipo === 'admin') {
                    await this.renderProfessores(content);
                } else if (this.currentView === 'alunos') {
                    await this.renderAlunos(content);
                } else if (this.currentView === 'provas' && this.currentUserData.tipo === 'aluno') {
                    await this.renderProvas(content);
                } else {
                    content.innerHTML = '<div class="text-center text-gray-500">Acesso restrito ou n√£o encontrado.</div>';
                }
            },

            // ==================== DASHBOARD ====================
            async renderDashboard(container) {
                // DASHBOARD PROFESSOR
                if (this.currentUserData.tipo === 'professor') {
                    const turmas = (await this.getCollection('turmas')).filter(t => t.professores && t.professores.includes(this.currentUserData.id));
                    const users = await this.getCollection('users');
                    const provasData = await this.getProvasData(users); // Busca notas (ou mock)

                    container.innerHTML = `
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Di√°rio de Classe</h2>
                            <p class="text-gray-600">Gest√£o das suas turmas e desempenho dos alunos.</p>
                        </div>
                    `;

                    if (turmas.length === 0) {
                        container.innerHTML += `<div class="bg-yellow-50 p-4 rounded-lg text-yellow-700">Voc√™ ainda n√£o est√° vinculado a nenhuma turma.</div>`;
                        return;
                    }

                    const turmasHtml = turmas.map(t => {
                        // Alunos desta turma
                        const alunosDaTurma = users.filter(u => t.alunos && t.alunos.includes(u.id));
                        
                        return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-blue-900">${t.nome}</h3>
                                    <p class="text-xs text-gray-500">${alunosDaTurma.length} Alunos matriculados</p>
                                </div>
                                <button onclick="app.navigate('materiais')" class="text-sm bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 text-gray-600">
                                    <i class="fas fa-book mr-1"></i> Materiais
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-white border-b">
                                        <tr>
                                            <th class="p-4 w-1/3">Aluno</th>
                                            <th class="p-4">Avalia√ß√µes e Notas</th>
                                            <th class="p-4 text-right">Situa√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${alunosDaTurma.length > 0 ? alunosDaTurma.map(aluno => {
                                            // Notas deste aluno
                                            const notasAluno = provasData.filter(p => p.alunoId === aluno.id);
                                            const media = notasAluno.length ? (notasAluno.reduce((acc, curr) => acc + parseFloat(curr.nota), 0) / notasAluno.length).toFixed(1) : '-';
                                            
                                            return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="p-4 font-medium text-gray-900 flex items-center gap-3">
                                                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">
                                                        ${aluno.nome.charAt(0)}
                                                    </div>
                                                    ${aluno.nome}
                                                </td>
                                                <td class="p-4">
                                                    <div class="flex flex-wrap gap-2">
                                                        ${notasAluno.length > 0 ? notasAluno.map(n => `
                                                            <div class="bg-gray-100 px-2 py-1 rounded text-xs border border-gray-200" title="${n.titulo}">
                                                                <span class="text-gray-500 mr-1">P${n.id.slice(-1)}:</span>
                                                                <span class="font-bold ${n.nota >= 6 ? 'text-green-600' : 'text-red-600'}">${n.nota}</span>
                                                            </div>
                                                        `).join('') : '<span class="text-gray-400 italic">Sem notas</span>'}
                                                    </div>
                                                </td>
                                                <td class="p-4 text-right">
                                                    ${media !== '-' ? `
                                                        <span class="font-bold ${media >= 6 ? 'text-green-600' : 'text-red-600'}">${media}</span>
                                                    ` : '-'}
                                                </td>
                                            </tr>
                                            `;
                                        }).join('') : `<tr><td colspan="3" class="p-6 text-center text-gray-400">Nenhum aluno nesta turma.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        `;
                    }).join('');
                    
                    container.innerHTML += turmasHtml;
                } 
                // DASHBOARD ALUNO
                else if (this.currentUserData.tipo === 'aluno') {
                    const turmas = await this.getCollection('turmas');
                    const minhasTurmas = turmas.filter(t => t.alunos && t.alunos.includes(this.currentUserData.id));
                    const users = await this.getCollection('users'); // Necess√°rio para simular notas consistentes
                    const provasData = await this.getProvasData(users);
                    const minhasProvas = provasData.filter(p => p.alunoId === this.currentUserData.id);

                    container.innerHTML = `
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Ol√°, ${this.currentUserData.nome} üëã</h2>
                            <p class="text-gray-600">Resumo do seu desempenho acad√™mico.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-blue-600 text-white rounded-xl shadow-lg p-6">
                                <h3 class="text-blue-100 text-sm font-medium">Turmas Matriculadas</h3>
                                <p class="text-3xl font-bold mt-2">${minhasTurmas.length}</p>
                            </div>
                             <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <h3 class="text-gray-500 text-sm font-medium">Provas Realizadas</h3>
                                <p class="text-3xl font-bold text-green-600 mt-2">${minhasProvas.length}</p>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Minhas Turmas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${minhasTurmas.map(t => `
                                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                                    <div><h4 class="font-bold text-lg">${t.nome}</h4></div>
                                    <div class="bg-blue-50 text-blue-600 p-2 rounded-lg"><i class="fas fa-chalkboard"></i></div>
                                </div>
                            `).join('')}
                            ${minhasTurmas.length === 0 ? '<p class="text-gray-500">Voc√™ n√£o est√° vinculado a nenhuma turma.</p>' : ''}
                        </div>
                    `;
                } 
                // DASHBOARD ADMIN
                else {
                    const turmas = await this.getCollection('turmas');
                    const users = await this.getCollection('users');
                    const alunosCount = users.filter(u => u.tipo === 'aluno').length;
                    const profsCount = users.filter(u => u.tipo === 'professor').length;

                    container.innerHTML = `
                         <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Painel de Controle</h2>
                            <p class="text-gray-600">Vis√£o geral administrativa.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <h3 class="text-gray-500 text-sm font-medium">Turmas Ativas</h3>
                                <p class="text-3xl font-bold text-blue-600 mt-2">${turmas.length}</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <h3 class="text-gray-500 text-sm font-medium">Total de Alunos</h3>
                                <p class="text-3xl font-bold text-blue-600 mt-2">${alunosCount}</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <h3 class="text-gray-500 text-sm font-medium">Total de Professores</h3>
                                <p class="text-3xl font-bold text-blue-600 mt-2">${profsCount}</p>
                            </div>
                        </div>
                    `;
                }
            },

            // ==================== OUTRAS VIEWS (Manter Funcionalidades Anteriores) ====================

            async renderProfessores(container) {
                const professores = (await this.getCollection('users')).filter(u => u.tipo === 'professor');
                const turmas = await this.getCollection('turmas');

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Gerenciar Professores</h2>
                        <button onclick="app.modalProfessor()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800">
                            <i class="fas fa-plus mr-2"></i>Novo Professor
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-800 border-b">
                                <tr>
                                    <th class="p-4">Nome</th>
                                    <th class="p-4">Email</th>
                                    <th class="p-4">Turmas Vinculadas</th>
                                    <th class="p-4 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${professores.map(p => {
                                    const turmasProf = turmas.filter(t => t.professores && t.professores.includes(p.id))
                                                             .map(t => t.nome).join(', ');
                                    return `
                                    <tr class="hover:bg-gray-50 group">
                                        <td class="p-4 font-medium text-gray-900">${p.nome}</td>
                                        <td class="p-4">${p.email}</td>
                                        <td class="p-4"><span class="badge badge-blue">${turmasProf || 'Nenhuma'}</span></td>
                                        <td class="p-4 text-right">
                                            <button onclick="app.modalProfessor('${p.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                                            <button onclick="app.deleteUsuario('${p.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            async modalProfessor(id = null) {
                let prof = null;
                if (id) {
                    const doc = await db.collection('users').doc(id).get();
                    prof = { id: doc.id, ...doc.data() };
                }
                const content = `
                    <div class="space-y-3">
                        ${!id ? `<div><label class="block text-sm font-medium mb-1">Email</label><input type="email" id="prof-email" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium mb-1">Senha</label><input type="password" id="prof-pass" class="w-full px-4 py-2 border rounded-lg"></div>` : ''}
                        <div><label class="block text-sm font-medium mb-1">Nome</label><input type="text" id="prof-nome" value="${prof ? prof.nome : ''}" class="w-full px-4 py-2 border rounded-lg"></div>
                        <p class="text-xs text-gray-500 bg-yellow-50 p-2 rounded">V√≠nculo com turmas √© feito na edi√ß√£o da Turma.</p>
                    </div>
                `;
                this.showModal(id ? 'Editar Professor' : 'Novo Professor', content, async () => {
                    const nome = document.getElementById('prof-nome').value;
                    if (!id) {
                        const email = document.getElementById('prof-email').value;
                        const pass = document.getElementById('prof-pass').value;
                        if (!email || !pass || !nome) return alert('Preencha tudo');
                        const uid = db.collection('users').doc().id;
                        await db.collection('users').doc(uid).set({ nome, email, tipo: 'professor', criado: firebase.firestore.FieldValue.serverTimestamp() });
                        alert('Professor criado (Simula√ß√£o: Auth requer backend real).');
                    } else await db.collection('users').doc(id).update({ nome });
                    this.renderContent();
                });
            },

            async renderTurmas(container) {
                const turmas = await this.getCollection('turmas');
                const professores = (await this.getCollection('users')).filter(u => u.tipo === 'professor');
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Gerenciar Turmas</h2><button onclick="app.modalTurma()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800"><i class="fas fa-plus mr-2"></i>Nova Turma</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${turmas.map(t => {
                            const profsNomes = professores.filter(p => t.professores && t.professores.includes(p.id)).map(p => p.nome).join(', ');
                            return `<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 relative group">
                                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition"><button onclick="app.modalTurma('${t.id}')" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button><button onclick="app.deleteItem('turmas', '${t.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>
                                    <h3 class="font-bold text-lg">${t.nome}</h3><p class="text-sm text-gray-500 mt-1"><i class="fas fa-chalkboard-teacher mr-1"></i> ${profsNomes || 'Sem prof'}</p><p class="text-sm text-gray-500 mt-1"><i class="fas fa-users mr-1"></i> ${t.alunos?.length || 0} alunos</p>
                                </div>`;
                        }).join('')}
                    </div>`;
            },

            async modalTurma(id = null) {
                const professores = (await this.getCollection('users')).filter(u => u.tipo === 'professor');
                let turma = null;
                if (id) { const doc = await db.collection('turmas').doc(id).get(); turma = { id: doc.id, ...doc.data() }; }
                const content = `<div><label class="block text-sm font-medium mb-1">Nome da Turma</label><input type="text" id="turma-nome" value="${turma ? turma.nome : ''}" class="w-full px-4 py-2 border rounded-lg mb-4"><label class="block text-sm font-medium mb-1">Professores</label><div class="max-h-40 overflow-y-auto border rounded-lg p-2 bg-gray-50">${professores.map(p => `<label class="flex items-center space-x-2 p-1 hover:bg-gray-200 rounded cursor-pointer"><input type="checkbox" class="prof-check" value="${p.id}" ${turma && turma.professores && turma.professores.includes(p.id) ? 'checked' : ''}><span>${p.nome}</span></label>`).join('')}</div></div>`;
                this.showModal(id ? 'Editar Turma' : 'Nova Turma', content, async () => {
                    const nome = document.getElementById('turma-nome').value;
                    const profIds = Array.from(document.querySelectorAll('.prof-check:checked')).map(c => c.value);
                    if (!nome) return alert('Nome obrigat√≥rio');
                    const data = { nome, professores: profIds };
                    if (id) await db.collection('turmas').doc(id).update(data);
                    else await db.collection('turmas').add({ ...data, alunos: [], criado: firebase.firestore.FieldValue.serverTimestamp() });
                    this.renderContent();
                });
            },

            async renderAlunos(container) {
                const turmas = await this.getCollection('turmas');
                let alunos = (await this.getCollection('users')).filter(u => u.tipo === 'aluno');
                if (this.currentUserData.tipo === 'professor') {
                    const minhasTurmasIds = turmas.filter(t => t.professores?.includes(this.currentUserData.id)).map(t => t.id);
                    alunos = alunos.filter(a => turmas.some(t => minhasTurmasIds.includes(t.id) && t.alunos && t.alunos.includes(a.id)));
                }
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Gerenciar Alunos</h2><button onclick="app.modalAluno()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800"><i class="fas fa-plus mr-2"></i>Novo Aluno</button></div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 border-b"><tr><th class="p-4">Nome</th><th class="p-4">Email</th><th class="p-4">Turmas</th><th class="p-4 text-right">A√ß√µes</th></tr></thead>
                    <tbody class="divide-y divide-gray-100">${alunos.map(a => {
                        const turmasAluno = turmas.filter(t => t.alunos && t.alunos.includes(a.id)).map(t => t.nome).join(', ');
                        return `<tr class="hover:bg-gray-50 group"><td class="p-4 font-medium text-gray-900">${a.nome}</td><td class="p-4">${a.email}</td><td class="p-4"><span class="badge badge-blue">${turmasAluno || 'Nenhuma'}</span></td><td class="p-4 text-right"><button onclick="app.modalAluno('${a.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>${this.currentUserData.tipo === 'admin' ? `<button onclick="app.deleteUsuario('${a.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`;
                    }).join('')}</tbody></table></div>`;
            },

            async modalAluno(id = null) {
                const turmas = await this.getCollection('turmas');
                let aluno = null; let turmasDoAluno = [];
                if (id) { const doc = await db.collection('users').doc(id).get(); aluno = { id: doc.id, ...doc.data() }; turmasDoAluno = turmas.filter(t => t.alunos && t.alunos.includes(id)).map(t => t.id); }
                const content = `<div class="space-y-3">${!id ? `<div><label class="block text-sm font-medium mb-1">Email</label><input type="email" id="alu-email" class="w-full px-4 py-2 border rounded-lg"></div><div><label class="block text-sm font-medium mb-1">Senha</label><input type="password" id="alu-pass" class="w-full px-4 py-2 border rounded-lg"></div>` : ''}<div><label class="block text-sm font-medium mb-1">Nome</label><input type="text" id="alu-nome" value="${aluno ? aluno.nome : ''}" class="w-full px-4 py-2 border rounded-lg"></div><div><label class="block text-sm font-medium mb-1">Vincular √†s Turmas</label><div class="max-h-40 overflow-y-auto border rounded-lg p-2 bg-gray-50">${turmas.map(t => `<label class="flex items-center space-x-2 p-1 hover:bg-gray-200 rounded cursor-pointer"><input type="checkbox" class="turma-check" value="${t.id}" ${turmasDoAluno.includes(t.id) ? 'checked' : ''}><span>${t.nome}</span></label>`).join('')}</div></div></div>`;
                this.showModal(id ? 'Editar Aluno' : 'Novo Aluno', content, async () => {
                    const nome = document.getElementById('alu-nome').value;
                    const novasTurmasIds = Array.from(document.querySelectorAll('.turma-check:checked')).map(c => c.value);
                    let uid = id;
                    if (!id) {
                        const email = document.getElementById('alu-email').value; const pass = document.getElementById('alu-pass').value;
                        if (!email || !pass || !nome) return alert('Preencha tudo');
                        uid = db.collection('users').doc().id;
                        await db.collection('users').doc(uid).set({ nome, email, tipo: 'aluno', criado: firebase.firestore.FieldValue.serverTimestamp() });
                        alert('Aluno criado (Simula√ß√£o).');
                    } else await db.collection('users').doc(uid).update({ nome });
                    
                    const todasTurmas = await this.getCollection('turmas');
                    for (const t of todasTurmas) { if (t.alunos && t.alunos.includes(uid)) await db.collection('turmas').doc(t.id).update({ alunos: firebase.firestore.FieldValue.arrayRemove(uid) }); }
                    for (const tid of novasTurmasIds) { await db.collection('turmas').doc(tid).update({ alunos: firebase.firestore.FieldValue.arrayUnion(uid) }); }
                    this.renderContent();
                });
            },

            async renderMateriais(container) {
                const turmas = await this.getCollection('turmas');
                let materiais = await this.getCollection('materiais');
                if (this.currentUserData.tipo === 'aluno') {
                    const minhasTurmas = turmas.filter(t => t.alunos?.includes(this.currentUserData.id)).map(t => t.id);
                    materiais = materiais.filter(m => minhasTurmas.includes(m.turmaId));
                } else if (this.currentUserData.tipo === 'professor') {
                     const minhasTurmas = turmas.filter(t => t.professores?.includes(this.currentUserData.id)).map(t => t.id);
                     materiais = materiais.filter(m => minhasTurmas.includes(m.turmaId) || m.professorId === this.currentUserData.id);
                }
                container.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Materiais Did√°ticos</h2><button onclick="app.showAddMaterialModal()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800"><i class="fas fa-plus mr-2"></i>Adicionar Material</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${materiais.map(m => {
                    let icon = m.tipo === 'youtube' ? 'fa-youtube text-red-600' : (m.tipo === 'link' ? 'fa-link text-green-600' : 'fa-file-alt text-blue-600');
                    const canEdit = this.currentUserData.tipo === 'admin' || this.currentUserData.tipo === 'professor' || (this.currentUserData.tipo === 'aluno' && m.professorId === this.currentUserData.id);
                    return `<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 card-hover relative group">${canEdit ? `<div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition bg-white p-1"><button onclick="app.showAddMaterialModal('${m.id}')" class="text-blue-600 mx-1"><i class="fas fa-edit"></i></button><button onclick="app.deleteItem('materiais', '${m.id}')" class="text-red-500 mx-1"><i class="fas fa-trash"></i></button></div>` : ''}<div class="flex items-start gap-4 mb-4"><div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fas ${icon} text-xl"></i></div><div class="flex-1 min-w-0"><h3 class="font-bold text-gray-900 truncate">${m.titulo}</h3><p class="text-xs text-gray-500 mt-1">${m.turmaNome || 'Geral'}</p></div></div><a href="${m.url}" target="_blank" class="block w-full py-2 bg-blue-50 text-blue-700 text-center rounded-lg hover:bg-blue-100 text-sm font-medium">Acessar</a></div>`;
                }).join('')}</div>`;
            },

            async showAddMaterialModal(editId = null) {
                let material = null; if (editId) { const doc = await db.collection('materiais').doc(editId).get(); material = { id: doc.id, ...doc.data() }; }
                const turmas = await this.getCollection('turmas');
                let turmasPermitidas = turmas;
                if (this.currentUserData.tipo === 'professor') turmasPermitidas = turmas.filter(t => t.professores?.includes(this.currentUserData.id));
                const options = turmasPermitidas.map(t => `<option value="${t.id}" data-nome="${t.nome}" ${material && material.turmaId === t.id ? 'selected' : ''}>${t.nome}</option>`).join('');
                const content = `<div class="space-y-4"><div><label class="block text-sm font-medium mb-1">T√≠tulo</label><input type="text" id="mat-titulo" value="${material ? material.titulo : ''}" class="w-full px-4 py-2 border rounded-lg"></div><div><label class="block text-sm font-medium mb-1">Turma</label><select id="mat-turma" class="w-full px-4 py-2 border rounded-lg"><option value="">Selecione...</option>${options}</select></div>${!editId ? `<div><label class="block text-sm font-medium mb-1">Tipo</label><div class="flex gap-2"><button type="button" onclick="app.toggleMatType('arquivo')" id="btn-arquivo" class="flex-1 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg text-sm">Arquivo</button><button type="button" onclick="app.toggleMatType('link')" id="btn-link" class="flex-1 py-2 border-2 border-gray-200 text-gray-600 rounded-lg text-sm">Link</button></div></div><div id="area-arquivo" class="mt-2"><input type="file" id="mat-file" class="w-full text-sm text-gray-500"></div><div id="area-link" class="hidden mt-2"><input type="url" id="mat-url" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg"></div>` : ''}</div>`;
                this.showModal(editId ? 'Editar Material' : 'Novo Material', content, async () => {
                    const titulo = document.getElementById('mat-titulo').value;
                    const select = document.getElementById('mat-turma');
                    const turmaId = select.value;
                    const turmaNome = select.options[select.selectedIndex]?.dataset.nome;
                    if (!titulo || !turmaId) throw new Error('Preencha t√≠tulo e turma');
                    const data = { titulo, turmaId, turmaNome };
                    if (editId) { await db.collection('materiais').doc(editId).update(data); } else {
                        const tipo = this.currentMaterialType;
                        let url = '';
                        if (tipo === 'link') { url = document.getElementById('mat-url').value; data.tipo = url.includes('youtu') ? 'youtube' : 'link'; } 
                        else { const file = document.getElementById('mat-file').files[0]; if (!file) throw new Error('Selecione arquivo'); const ref = storage.ref().child(`materiais/${Date.now()}_${file.name}`); await ref.put(file); url = await ref.getDownloadURL(); data.tipo = file.name.split('.').pop(); }
                        data.url = url; data.professorId = this.currentUserData.id; data.professorNome = this.currentUserData.nome; data.criado = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('materiais').add(data);
                    }
                    this.renderContent();
                });
            },

            toggleMatType(type) {
                this.currentMaterialType = type;
                if(type === 'arquivo') {
                    document.getElementById('area-arquivo').classList.remove('hidden'); document.getElementById('area-link').classList.add('hidden');
                    document.getElementById('btn-arquivo').className = 'flex-1 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg text-sm';
                    document.getElementById('btn-link').className = 'flex-1 py-2 border-2 border-gray-200 text-gray-600 rounded-lg text-sm';
                } else {
                    document.getElementById('area-arquivo').classList.add('hidden'); document.getElementById('area-link').classList.remove('hidden');
                    document.getElementById('btn-link').className = 'flex-1 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg text-sm';
                    document.getElementById('btn-arquivo').className = 'flex-1 py-2 border-2 border-gray-200 text-gray-600 rounded-lg text-sm';
                }
            },

            async renderProvas(container) {
                const users = await this.getCollection('users');
                const provasData = await this.getProvasData(users);
                const minhasProvas = provasData.filter(p => p.alunoId === this.currentUserData.id);

                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Boletim de Notas</h2>
                    <div class="space-y-4">
                        ${minhasProvas.map(p => `
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                <div>
                                    <span class="badge ${p.status === 'realizada' ? 'badge-green' : 'badge-yellow'} mb-2 inline-block">${p.status || 'Realizada'}</span>
                                    <h3 class="font-bold text-lg">${p.titulo}</h3>
                                    <span class="text-sm text-gray-500">${p.data || 'Data n√£o inf.'}</span>
                                </div>
                                <div class="text-2xl font-bold ${p.nota >= 6 ? 'text-green-600' : 'text-red-600'}">${p.nota}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            // ==================== HELPERS E UTILS ====================

            // Simula um banco de notas para demonstra√ß√£o (Garante que todo aluno tenha notas para ver)
            async getProvasData(alunosReais) {
                // Tenta buscar 'notas' se existisse collection. Como n√£o existe, gera mock consistente.
                // O mock usa o ID do aluno para ser persistente durante a sess√£o.
                const alunos = alunosReais.filter(u => u.tipo === 'aluno');
                let notas = [];
                alunos.forEach(aluno => {
                    // Gera notas "pseudo-aleat√≥rias" baseadas no ID do aluno para n√£o mudar a cada refresh
                    const seed = aluno.id.charCodeAt(0); 
                    const n1 = ((seed % 4) + 6).toFixed(1); // Nota entre 6 e 10
                    const n2 = ((seed % 5) + 4).toFixed(1); // Nota entre 4 e 9
                    
                    notas.push({ id: `p1_${aluno.id}`, alunoId: aluno.id, titulo: 'Avalia√ß√£o Parcial', data: '10/02/2025', nota: n1, status: 'realizada' });
                    notas.push({ id: `p2_${aluno.id}`, alunoId: aluno.id, titulo: 'Prova Bimestral', data: '25/02/2025', nota: n2, status: 'realizada' });
                });
                return notas;
            },

            showModal(title, content, onConfirm) {
                const modalId = 'modal-' + Date.now();
                const div = document.createElement('div');
                div.id = modalId;
                div.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in';
                div.innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto"><div class="p-6 border-b flex justify-between items-center"><h3 class="font-bold text-lg">${title}</h3><button onclick="document.getElementById('${modalId}').remove()"><i class="fas fa-times"></i></button></div><div class="p-6">${content}</div><div class="p-6 border-t flex justify-end gap-3"><button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 text-gray-600">Cancelar</button><button id="btn-conf-${modalId}" class="px-4 py-2 bg-blue-700 text-white rounded-lg">Salvar</button></div></div>`;
                document.body.appendChild(div);
                document.getElementById(`btn-conf-${modalId}`).onclick = async () => { try { await onConfirm(); document.getElementById(modalId).remove(); this.showToast('Sucesso!'); } catch(e) { alert(e.message); } };
            },

            async deleteItem(col, id) { if(confirm('Excluir?')) { await db.collection(col).doc(id).delete(); this.renderContent(); } },
            async deleteUsuario(id) { if(confirm('Remover usu√°rio?')) { await db.collection('users').doc(id).delete(); this.renderContent(); } },
            async getCollection(name) { const s = await db.collection(name).get(); return s.docs.map(d => ({id:d.id, ...d.data()})); },
            showToast(m) { const t = document.getElementById('toast-container'); const e = document.createElement('div'); e.className = 'bg-gray-800 text-white px-6 py-3 rounded shadow-lg mb-2 fade-in'; e.innerText = m; t.appendChild(e); setTimeout(() => e.remove(), 3000); },
            capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        };

        app.init();
    </script>
</body>
</html>
