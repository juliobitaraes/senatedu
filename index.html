<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduCloud Pro - Sistema com Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .sync-status { position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 100; }
        .sync-online { background: #10b981; color: white; }
        .sync-offline { background: #ef4444; color: white; }
        .timer-bar { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 1s linear; }
        .quiz-timer { width: 100%; height: 4px; background: #e5e7eb; position: fixed; top: 0; left: 0; z-index: 50; }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <div id="sync-indicator" class="sync-status sync-online hidden">
        <i class="fas fa-cloud"></i> <span id="sync-text">Online</span>
    </div>

    <div id="app"></div>

    <!-- Template: Login Firebase -->
    <template id="login-template">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 via-purple-600 to-pink-500 p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 space-y-6 fade-in">
                <div class="text-center space-y-2">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
                        <i class="fas fa-graduation-cap text-3xl text-white"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900">EduCloud Pro</h1>
                    <p class="text-gray-500">Sistema em Nuvem com Firebase</p>
                </div>
                
                <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center"></div>
                
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="email@exemplo.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••">
                    </div>
                    <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
                        <span id="btn-text">Entrar</span>
                    </button>
                </form>

                <div class="space-y-2 text-center text-sm">
                    <p class="text-gray-500">Primeiro acesso?</p>
                    <button onclick="app.setupFirstAdmin()" class="text-blue-600 hover:underline font-medium">
                        Criar conta de Administrador
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="main-layout">
        <div class="min-h-screen flex flex-col md:flex-row">
            <aside id="sidebar" class="bg-gray-900 text-white w-64 flex-shrink-0 fixed h-screen overflow-y-auto z-30 hidden md:block">
                <div class="p-6 border-b border-gray-800">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold">EduCloud</h1>
                            <p class="text-xs text-gray-400" id="user-role">...</p>
                        </div>
                    </div>
                </div>
                <nav class="p-4 space-y-2" id="sidebar-nav"></nav>
                <div class="absolute bottom-0 w-full p-4 border-t border-gray-800 bg-gray-900">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-sm font-bold" id="user-avatar">U</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate" id="user-name">...</p>
                            <p class="text-xs text-gray-400 truncate" id="user-email">...</p>
                        </div>
                    </div>
                    <button onclick="app.logout()" class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition text-sm">
                        <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
                    </button>
                </div>
            </aside>

            <main class="flex-1 md:ml-64 min-h-screen">
                <div class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-10">
                    <button onclick="app.toggleSidebar()" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                    <span class="font-semibold">EduCloud</span>
                    <div class="w-8"></div>
                </div>
                <div id="content-area" class="p-4 md:p-8 fade-in"></div>
            </main>
        </div>
    </template>

    <script>
        // ==================== SUAS CREDENCIAIS FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyChnKOxAQH9RqSYmvcf3zYmajg3p5LCogc",
            authDomain: "educloud-sistema.firebaseapp.com",
            projectId: "educloud-sistema",
            storageBucket: "educloud-sistema.firebasestorage.app",
            messagingSenderId: "279645366191",
            appId: "1:279645366191:web:df16df577ccc959a4f315a"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const app = {
            currentUser: null,
            currentUserData: null,
            currentView: 'dashboard',
            timerInterval: null,

            init() {
                this.renderLogin();
                this.monitorAuth();
                this.monitorConnection();
            },

            monitorAuth() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Buscar dados adicionais do usuário no Firestore
                        const doc = await db.collection('users').doc(user.uid).get();
                        if (doc.exists) {
                            this.currentUser = user;
                            this.currentUserData = { id: user.uid, ...doc.data() };
                            this.renderMainLayout();
                        } else {
                            auth.signOut();
                            alert('Usuário autenticado mas sem perfil completo no sistema');
                        }
                    } else {
                        this.currentUser = null;
                        this.currentUserData = null;
                        this.renderLogin();
                    }
                });
            },

            monitorConnection() {
                const indicator = document.getElementById('sync-indicator');
                const text = document.getElementById('sync-text');
                
                window.addEventListener('online', () => {
                    indicator.className = 'sync-status sync-online';
                    text.textContent = 'Online - Sincronizado';
                    indicator.classList.remove('hidden');
                    setTimeout(() => indicator.classList.add('hidden'), 3000);
                });
                
                window.addEventListener('offline', () => {
                    indicator.className = 'sync-status sync-offline';
                    text.textContent = 'Offline - Dados locais';
                    indicator.classList.remove('hidden');
                });
            },

            renderLogin() {
                document.getElementById('app').innerHTML = document.getElementById('login-template').innerHTML;
                
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const btn = document.getElementById('login-btn');
                    const btnText = document.getElementById('btn-text');
                    const error = document.getElementById('login-error');
                    
                    btn.disabled = true;
                    btnText.innerHTML = '<div class="loading"></div>';
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                    } catch (err) {
                        error.textContent = this.getAuthError(err.code);
                        error.classList.remove('hidden');
                        btn.disabled = false;
                        btnText.textContent = 'Entrar';
                    }
                });
            },

            getAuthError(code) {
                const errors = {
                    'auth/user-not-found': 'Usuário não encontrado. Verifique o email.',
                    'auth/wrong-password': 'Senha incorreta.',
                    'auth/invalid-email': 'Email inválido.',
                    'auth/too-many-requests': 'Muitas tentativas. Tente mais tarde.',
                    'auth/invalid-credential': 'Email ou senha incorretos.'
                };
                return errors[code] || 'Erro ao autenticar. Tente novamente.';
            },

            async setupFirstAdmin() {
                const nome = prompt('Digite seu nome completo:');
                const email = prompt('Digite seu email (será o login):');
                const senha = prompt('Crie uma senha (mínimo 6 caracteres):');
                
                if (!nome || !email || !senha) {
                    alert('Preencha todos os campos');
                    return;
                }
                
                if (senha.length < 6) {
                    alert('A senha deve ter pelo menos 6 caracteres');
                    return;
                }
                
                try {
                    // Criar usuário na autenticação
                    const userCred = await auth.createUserWithEmailAndPassword(email, senha);
                    
                    // Salvar dados no Firestore
                    await db.collection('users').doc(userCred.user.uid).set({
                        nome: nome,
                        email: email,
                        tipo: 'admin',
                        criado: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Administrador criado com sucesso! Você será conectado automaticamente.');
                } catch (err) {
                    alert('Erro ao criar admin: ' + err.message);
                }
            },

            logout() {
                auth.signOut();
            },

            renderMainLayout() {
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = document.getElementById('main-layout').innerHTML;
                
                document.getElementById('user-name').textContent = this.currentUserData.nome;
                document.getElementById('user-email').textContent = this.currentUserData.email;
                document.getElementById('user-avatar').textContent = this.currentUserData.nome.charAt(0).toUpperCase();
                
                const roles = { admin: 'Administrador', professor: 'Professor', aluno: 'Aluno' };
                document.getElementById('user-role').textContent = roles[this.currentUserData.tipo] || 'Usuário';
                
                this.renderSidebar();
                this.renderContent();
            },

            renderSidebar() {
                const nav = document.getElementById('sidebar-nav');
                const type = this.currentUserData.tipo;
                
                const menus = {
                    admin: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'professores', icon: 'fa-chalkboard-teacher', label: 'Professores' },
                        { id: 'turmas', icon: 'fa-users', label: 'Turmas' },
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Todos Alunos' },
                        { id: 'config', icon: 'fa-cog', label: 'Configurações' }
                    ],
                    professor: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'turmas', icon: 'fa-users', label: 'Minhas Turmas' },
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Meus Alunos' },
                        { id: 'provas', icon: 'fa-file-alt', label: 'Provas' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' },
                        { id: 'notas', icon: 'fa-star', label: 'Lançar Notas' }
                    ],
                    aluno: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'provas', icon: 'fa-file-alt', label: 'Provas' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' },
                        { id: 'minhas-notas', icon: 'fa-star', label: 'Minhas Notas' }
                    ]
                };

                const items = menus[type] || [];
                nav.innerHTML = items.map(item => `
                    <button onclick="app.navigate('${item.id}')" 
                        class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition ${this.currentView === item.id ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800 hover:text-white'}">
                        <i class="fas ${item.icon} w-5"></i>
                        <span>${item.label}</span>
                    </button>
                `).join('');
            },

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('hidden');
            },

            navigate(view) {
                this.currentView = view;
                this.renderSidebar();
                this.renderContent();
                if (window.innerWidth < 768) {
                    this.toggleSidebar();
                }
            },

            // ==================== FIRESTORE CRUD ====================
            async getCollection(collection) {
                try {
                    const snapshot = await db.collection(collection).get();
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (err) {
                    console.error('Erro ao buscar:', err);
                    return [];
                }
            },

            async addDocument(collection, data) {
                try {
                    const docRef = await db.collection(collection).add({
                        ...data,
                        criado: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return docRef.id;
                } catch (err) {
                    this.showToast('Erro ao salvar: ' + err.message, 'error');
                    throw err;
                }
            },

            async updateDocument(collection, id, data) {
                await db.collection(collection).doc(id).update(data);
            },

            async deleteDocument(collection, id) {
                if (!confirm('Tem certeza que deseja excluir?')) return;
                try {
                    await db.collection(collection).doc(id).delete();
                    this.showToast('Excluído com sucesso!', 'success');
                    this.renderContent();
                } catch (err) {
                    this.showToast('Erro ao excluir', 'error');
                }
            },

            // ==================== RENDERIZAÇÃO ====================
            async renderContent() {
                const content = document.getElementById('content-area');
                content.innerHTML = '<div class="flex justify-center p-8"><div class="loading border-blue-600 border-t-transparent"></div></div>';
                
                try {
                    switch(this.currentView) {
                        case 'dashboard': await this.renderDashboard(content); break;
                        case 'professores': await this.renderProfessores(content); break;
                        case 'turmas': await this.renderTurmas(content); break;
                        case 'alunos': await this.renderAlunos(content); break;
                        case 'provas': await this.renderProvas(content); break;
                        case 'materiais': await this.renderMateriais(content); break;
                        case 'notas': await this.renderNotas(content); break;
                        case 'minhas-notas': await this.renderMinhasNotas(content); break;
                        case 'config': await this.renderConfig(content); break;
                        default: await this.renderDashboard(content);
                    }
                } catch (err) {
                    content.innerHTML = `<div class="text-red-600 text-center p-4">Erro ao carregar: ${err.message}</div>`;
                    console.error(err);
                }
            },

            async renderDashboard(container) {
                try {
                    const totalProf = (await db.collection('users').where('tipo', '==', 'professor').get()).size;
                    const totalAlunos = (await db.collection('users').where('tipo', '==', 'aluno').get()).size;
                    const totalTurmas = (await db.collection('turmas').get()).size;
                    const totalProvas = (await db.collection('provas').get()).size;

                    container.innerHTML = `
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                            <p class="text-gray-600">Dados sincronizados em tempo real</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 rounded-lg bg-blue-100 text-blue-600"><i class="fas fa-chalkboard-teacher text-xl"></i></div>
                                </div>
                                <h3 class="text-gray-500 text-sm font-medium">Professores</h3>
                                <p class="text-2xl font-bold text-gray-900 mt-1">${totalProf}</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 rounded-lg bg-green-100 text-green-600"><i class="fas fa-user-graduate text-xl"></i></div>
                                </div>
                                <h3 class="text-gray-500 text-sm font-medium">Alunos</h3>
                                <p class="text-2xl font-bold text-gray-900 mt-1">${totalAlunos}</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 rounded-lg bg-purple-100 text-purple-600"><i class="fas fa-users text-xl"></i></div>
                                </div>
                                <h3 class="text-gray-500 text-sm font-medium">Turmas</h3>
                                <p class="text-2xl font-bold text-gray-900 mt-1">${totalTurmas}</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 rounded-lg bg-orange-100 text-orange-600"><i class="fas fa-file-alt text-xl"></i></div>
                                </div>
                                <h3 class="text-gray-500 text-sm font-medium">Provas</h3>
                                <p class="text-2xl font-bold text-gray-900 mt-1">${totalProvas}</p>
                            </div>
                        </div>
                    `;
                } catch (err) {
                    container.innerHTML = '<div class="text-red-600">Erro ao carregar estatísticas</div>';
                }
            },

            async renderProfessores(container) {
                if (this.currentUserData.tipo !== 'admin') {
                    container.innerHTML = '<div class="text-red-600">Acesso restrito a administradores</div>';
                    return;
                }

                const professores = await this.getCollection('users');
                const profs = professores.filter(u => u.tipo === 'professor');

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Professores</h2>
                            <p class="text-gray-600">Gerencie os professores da instituição</p>
                        </div>
                        <button onclick="app.showModal('professor')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            <i class="fas fa-plus"></i> Novo Professor
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 font-semibold text-gray-800">
                                <tr>
                                    <th class="px-6 py-3">Nome</th>
                                    <th class="px-6 py-3">Email</th>
                                    <th class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${profs.map(p => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium text-gray-900">${p.nome}</td>
                                        <td class="px-6 py-4">${p.email}</td>
                                        <td class="px-6 py-4 text-right">
                                            <button onclick="app.deleteDocument('users', '${p.id}')" class="text-red-600 hover:text-red-800 p-2">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${profs.length === 0 ? '<p class="p-6 text-center text-gray-500">Nenhum professor cadastrado</p>' : ''}
                    </div>
                `;
            },

            async renderTurmas(container) {
                const turmas = await this.getCollection('turmas');
                const users = await this.getCollection('users');
                
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Turmas</h2>
                        ${this.currentUserData.tipo !== 'aluno' ? `
                        <button onclick="app.showModal('turma')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Nova Turma
                        </button>
                        ` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${turmas.map(t => {
                            const prof = users.find(u => u.id === t.professorId);
                            return `
                                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div class="h-32 bg-gradient-to-r from-blue-500 to-purple-600 p-6 flex justify-between items-start">
                                        <div class="mt-4">
                                            <h3 class="text-white text-xl font-bold">${t.nome}</h3>
                                            <p class="text-blue-100 text-sm">${t.serie || ''} • ${t.turno || ''}</p>
                                        </div>
                                        <button onclick="app.showQRCode('${t.id}')" class="bg-white bg-opacity-20 p-2 rounded-lg text-white hover:bg-opacity-30" title="QR Code">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                    </div>
                                    <div class="p-6">
                                        <p class="text-sm text-gray-600 mb-4">Professor: ${prof ? prof.nome : 'Não atribuído'}</p>
                                        <button onclick="app.viewTurma('${t.id}')" class="w-full py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium">
                                            Ver Detalhes
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            async renderAlunos(container) {
                const alunos = await this.getCollection('users');
                const lista = alunos.filter(u => u.tipo === 'aluno');

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Alunos</h2>
                        <button onclick="app.showModal('aluno')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Novo Aluno
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Nome</th>
                                    <th class="px-6 py-3">Email</th>
                                    <th class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${lista.map(a => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium">${a.nome}</td>
                                        <td class="px-6 py-4">${a.email}</td>
                                        <td class="px-6 py-4 text-right">
                                            <button onclick="app.deleteDocument('users', '${a.id}')" class="text-red-600 hover:text-red-800">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            async renderConfig(container) {
                container.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Configurações</h2>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                            <h3 class="font-bold text-lg mb-2">Status do Firebase</h3>
                            <p class="text-green-600 flex items-center gap-2">
                                <i class="fas fa-check-circle"></i> Conectado ao projeto: educloud-sistema
                            </p>
                            <p class="text-sm text-gray-600 mt-2">Dados sincronizados em tempo real</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="font-bold text-lg text-red-600 mb-3">Zona de Perigo</h3>
                            <p class="text-gray-600 mb-4">Estas ações afetam todos os dados na nuvem.</p>
                            <button onclick="app.clearAllData()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                <i class="fas fa-trash mr-2"></i>Limpar Todos os Dados
                            </button>
                        </div>
                    </div>
                `;
            },

            showModal(type) {
                if (type === 'professor') {
                    const nome = prompt('Nome do professor:');
                    const email = prompt('Email do professor:');
                    const senha = prompt('Senha temporária (mín 6 caracteres):');
                    
                    if (nome && email && senha) {
                        auth.createUserWithEmailAndPassword(email, senha).then(cred => {
                            return db.collection('users').doc(cred.user.uid).set({
                                nome, email, tipo: 'professor',
                                criado: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }).then(() => {
                            this.showToast('Professor criado!', 'success');
                            this.renderContent();
                        }).catch(err => alert(err.message));
                    }
                } else if (type === 'turma') {
                    const nome = prompt('Nome da turma (ex: 1º Ano A):');
                    const serie = prompt('Série:');
                    const turno = prompt('Turno (Manhã/Tarde/Noite):');
                    
                    if (nome) {
                        this.addDocument('turmas', {
                            nome, serie, turno,
                            professorId: this.currentUserData.tipo === 'professor' ? this.currentUser.uid : null,
                            alunos: []
                        }).then(() => {
                            this.showToast('Turma criada!', 'success');
                            this.renderContent();
                        });
                    }
                }
            },

            showQRCode(turmaId) {
                const div = document.createElement('div');
                div.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                div.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center max-w-sm w-full">
                        <h3 class="text-xl font-bold mb-4">QR Code da Turma</h3>
                        <div id="qrcode" class="flex justify-center mb-4"></div>
                        <p class="text-sm text-gray-600 mb-4">Escaneie para matricular-se</p>
                        <button onclick="this.closest('.fixed').remove()" class="w-full py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Fechar</button>
                    </div>
                `;
                document.body.appendChild(div);
                new QRCode(document.getElementById('qrcode'), {
                    text: `https://educloud-sistema.web.app/matricula?turma=${turmaId}`,
                    width: 200,
                    height: 200
                });
            },

            viewTurma(id) {
                alert('Detalhes da turma ' + id + ' (funcionalidade em desenvolvimento)');
            },

            async clearAllData() {
                if (!confirm('ATENÇÃO: Isso apagará TODOS os dados permanentemente do Firebase!\n\nTem certeza?')) return;
                
                const collections = ['users', 'turmas', 'provas', 'notas', 'materiais'];
                try {
                    for (const col of collections) {
                        const snapshot = await db.collection(col).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                    this.showToast('Todos os dados foram apagados', 'success');
                    this.renderContent();
                } catch (err) {
                    alert('Erro ao limpar dados: ' + err.message);
                }
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                
                toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 fade-in`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        // Iniciar app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
