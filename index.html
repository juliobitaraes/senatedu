<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENATEDU - Sistema de Gestão Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .upload-area { border: 2px dashed #cbd5e1; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .progress-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #1e40af); transition: width 0.3s; }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <div id="app"></div>

    <script>
        // ==================== CONFIGURAÇÃO FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyChnKOxAQH9RqSYmvcf3zYmajg3p5LCogc",
            authDomain: "educloud-sistema.firebaseapp.com",
            projectId: "educloud-sistema",
            storageBucket: "educloud-sistema.firebasestorage.app",
            messagingSenderId: "279645366191",
            appId: "1:279645366191:web:df16df577ccc959a4f315a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const app = {
            currentUser: null,
            currentUserData: null,
            currentView: 'dashboard',
            currentMaterialType: 'arquivo',
            selectedFile: null,
            uploadTask: null,

            init() {
                this.renderLogin();
                this.monitorAuth();
            },

            monitorAuth() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const doc = await db.collection('users').doc(user.uid).get();
                        if (doc.exists) {
                            this.currentUser = user;
                            this.currentUserData = { id: user.uid, ...doc.data() };
                            this.renderMainLayout();
                        } else {
                            auth.signOut();
                        }
                    } else {
                        this.currentUser = null;
                        this.currentUserData = null;
                        this.renderLogin();
                    }
                });
            },

            renderLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-800 via-blue-600 to-blue-500 p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 space-y-6 fade-in">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-700 to-blue-500 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
                                    <i class="fas fa-graduation-cap text-3xl text-white"></i>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-900">SENATEDU</h1>
                                <p class="text-gray-500">Sistema de Gestão Escolar</p>
                            </div>
                            
                            <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center"></div>
                            
                            <form id="login-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="email@exemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                    <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••">
                                </div>
                                <button type="submit" id="login-btn" class="w-full bg-blue-700 text-white py-2 rounded-lg font-semibold hover:bg-blue-800 transition">
                                    <span id="btn-text">Entrar</span>
                                </button>
                            </form>

                            <div class="text-center text-sm">
                                <button onclick="app.setupFirstAdmin()" class="text-blue-600 hover:underline font-medium">
                                    Criar conta de Administrador
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const btnText = document.getElementById('btn-text');
                    
                    btnText.innerHTML = '<div class="loading"></div>';
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                    } catch (err) {
                        document.getElementById('login-error').textContent = 'Email ou senha incorretos';
                        document.getElementById('login-error').classList.remove('hidden');
                        btnText.textContent = 'Entrar';
                    }
                });
            },

            async setupFirstAdmin() {
                const nome = prompt('Digite seu nome completo:');
                const email = prompt('Digite seu email (será o login):');
                const senha = prompt('Crie uma senha (mínimo 6 caracteres):');
                
                if (!nome || !email || !senha) return;
                if (senha.length < 6) {
                    alert('A senha deve ter pelo menos 6 caracteres');
                    return;
                }
                
                try {
                    const userCred = await auth.createUserWithEmailAndPassword(email, senha);
                    await db.collection('users').doc(userCred.user.uid).set({
                        nome: nome,
                        email: email,
                        tipo: 'admin',
                        criado: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Administrador criado com sucesso!');
                } catch (err) {
                    alert('Erro: ' + err.message);
                }
            },

            logout() {
                auth.signOut();
            },

            renderMainLayout() {
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = `
                    <div class="min-h-screen flex flex-col md:flex-row">
                        <aside id="sidebar" class="bg-slate-900 text-white w-64 flex-shrink-0 fixed h-screen overflow-y-auto z-30 hidden md:block">
                            <div class="p-6 border-b border-slate-800">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-400 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-graduation-cap text-lg"></i>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold">SENATEDU</h1>
                                        <p class="text-xs text-slate-400">${this.currentUserData.tipo === 'admin' ? 'Administrador' : this.currentUserData.tipo === 'professor' ? 'Professor' : 'Aluno'}</p>
                                    </div>
                                </div>
                            </div>
                            <nav class="p-4 space-y-2" id="sidebar-nav"></nav>
                            <div class="absolute bottom-0 w-full p-4 border-t border-slate-800 bg-slate-900">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-sm font-bold">
                                        ${this.currentUserData.nome.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium truncate">${this.currentUserData.nome}</p>
                                        <p class="text-xs text-slate-400 truncate">${this.currentUserData.email}</p>
                                    </div>
                                </div>
                                <button onclick="app.logout()" class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition text-sm">
                                    <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
                                </button>
                            </div>
                        </aside>

                        <main class="flex-1 md:ml-64 min-h-screen">
                            <div class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-10">
                                <button onclick="document.getElementById('sidebar').classList.toggle('hidden')" class="text-gray-600">
                                    <i class="fas fa-bars text-xl"></i>
                                </button>
                                <span class="font-semibold text-blue-800">SENATEDU</span>
                                <div class="w-8"></div>
                            </div>
                            <div id="content-area" class="p-4 md:p-8 fade-in"></div>
                        </main>
                    </div>
                `;

                this.renderSidebar();
                this.renderContent();
            },

            renderSidebar() {
                const nav = document.getElementById('sidebar-nav');
                const type = this.currentUserData.tipo;
                
                const menus = {
                    admin: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'professores', icon: 'fa-chalkboard-teacher', label: 'Professores' },
                        { id: 'turmas', icon: 'fa-users', label: 'Turmas' },
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Alunos' }
                    ],
                    professor: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'turmas', icon: 'fa-users', label: 'Minhas Turmas' },
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Meus Alunos' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' }
                    ],
                    aluno: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' }
                    ]
                };

                const items = menus[type] || [];
                nav.innerHTML = items.map(item => `
                    <button onclick="app.navigate('${item.id}')" 
                        class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition ${this.currentView === item.id ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                        <i class="fas ${item.icon} w-5"></i>
                        <span>${item.label}</span>
                    </button>
                `).join('');
            },

            navigate(view) {
                this.currentView = view;
                this.renderSidebar();
                this.renderContent();
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                }
            },

            async renderContent() {
                const content = document.getElementById('content-area');
                
                if (this.currentView === 'dashboard') {
                    const totalProf = (await db.collection('users').where('tipo', '==', 'professor').get()).size;
                    const totalAlunos = (await db.collection('users').where('tipo', '==', 'aluno').get()).size;
                    
                    content.innerHTML = `
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Dashboard SENATEDU</h2>
                            <p class="text-gray-600">Resumo do sistema</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <h3 class="text-gray-500 text-sm font-medium">Professores</h3>
                                <p class="text-3xl font-bold text-blue-600 mt-2">${totalProf}</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <h3 class="text-gray-500 text-sm font-medium">Alunos</h3>
                                <p class="text-3xl font-bold text-blue-600 mt-2">${totalAlunos}</p>
                            </div>
                        </div>
                    `;
                } else if (this.currentView === 'materiais') {
                    await this.renderMateriais(content);
                } else {
                    content.innerHTML = '<div class="text-center text-gray-500">Funcionalidade em desenvolvimento</div>';
                }
            },

            async renderMateriais(container) {
                const turmas = await this.getCollection('turmas');
                let materiais = await this.getCollection('materiais');
                
                // Se for aluno, filtra só os da turma dele
                if (this.currentUserData.tipo === 'aluno') {
                    const turmaAluno = turmas.find(t => t.alunos?.includes(this.currentUserData.id));
                    if (turmaAluno) {
                        materiais = materiais.filter(m => m.turmaId === turmaAluno.id);
                    }
                }

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Materiais Didáticos</h2>
                        ${this.currentUserData.tipo === 'professor' ? `
                        <button onclick="app.showAddMaterialModal()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800">
                            <i class="fas fa-plus mr-2"></i>Adicionar Material
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${materiais.map(m => {
                            let icon, color, btnText;
                            
                            if (m.tipo === 'youtube') {
                                icon = 'fa-youtube';
                                color = 'text-red-600';
                                btnText = 'Assistir';
                            } else if (m.tipo === 'link') {
                                icon = 'fa-link';
                                color = 'text-green-600';
                                btnText = 'Acessar Link';
                            } else if (m.tipo === 'pdf') {
                                icon = 'fa-file-pdf';
                                color = 'text-red-500';
                                btnText = 'Baixar PDF';
                            } else if (['doc', 'docx'].includes(m.tipo)) {
                                icon = 'fa-file-word';
                                color = 'text-blue-600';
                                btnText = 'Baixar Documento';
                            } else if (['xls', 'xlsx'].includes(m.tipo)) {
                                icon = 'fa-file-excel';
                                color = 'text-green-600';
                                btnText = 'Baixar Planilha';
                            } else if (['ppt', 'pptx'].includes(m.tipo)) {
                                icon = 'fa-file-powerpoint';
                                color = 'text-orange-500';
                                btnText = 'Baixar Apresentação';
                            } else {
                                icon = 'fa-file';
                                color = 'text-gray-600';
                                btnText = 'Baixar Arquivo';
                            }
                            
                            return `
                                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 card-hover">
                                    <div class="flex items-start gap-4 mb-4">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fas ${icon} ${color} text-xl"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold text-gray-900 truncate" title="${m.titulo}">${m.titulo}</h3>
                                            <p class="text-xs text-gray-500 mt-1">${m.turmaNome || 'Geral'}</p>
                                            <p class="text-xs text-gray-400">${m.tipo.toUpperCase()}</p>
                                        </div>
                                    </div>
                                    <a href="${m.url}" target="_blank" class="block w-full py-2 bg-blue-50 text-blue-700 text-center rounded-lg hover:bg-blue-100 text-sm font-medium">
                                        <i class="fas fa-download mr-2"></i>${btnText}
                                    </a>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    ${materiais.length === 0 ? '<p class="text-center text-gray-500 mt-8">Nenhum material cadastrado</p>' : ''}
                `;
            },

            showAddMaterialModal() {
                const div = document.createElement('div');
                div.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                div.id = 'modal-materiais';
                div.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-screen overflow-y-auto">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">Adicionar Material</h3>
                            <button onclick="document.getElementById('modal-materiais').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Título *</label>
                                <input type="text" id="mat-titulo" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Aula de Matemática - Semana 1">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Turma *</label>
                                <select id="mat-turma" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Selecione a turma</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Material</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="app.selectMaterialType('arquivo')" id="btn-arquivo" class="flex-1 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium text-sm">
                                        <i class="fas fa-file-upload mr-1"></i>Arquivo
                                    </button>
                                    <button type="button" onclick="app.selectMaterialType('link')" id="btn-link" class="flex-1 py-2 border-2 border-gray-200 text-gray-600 rounded-lg text-sm">
                                        <i class="fas fa-link mr-1"></i>Link
                                    </button>
                                    <button type="button" onclick="app.selectMaterialType('youtube')" id="btn-youtube" class="flex-1 py-2 border-2 border-gray-200 text-gray-600 rounded-lg text-sm">
                                        <i class="fab fa-youtube mr-1"></i>YouTube
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Área de Upload de Arquivo -->
                            <div id="upload-area">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Arquivo (Máx 30MB)</label>
                                <div class="upload-area border-2 border-dashed rounded-lg p-6 text-center" onclick="document.getElementById('mat-file').click()">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600">Clique para selecionar ou arraste aqui</p>
                                    <p class="text-xs text-gray-400 mt-1">PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX, PNG, JPG</p>
                                    <input type="file" id="mat-file" class="hidden" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg" onchange="app.handleFile(this)">
                                </div>
                                <div id="file-info" class="hidden mt-2 p-3 bg-blue-50 rounded-lg">
                                    <p class="text-sm font-medium text-blue-800" id="file-name"></p>
                                    <p class="text-xs text-blue-600" id="file-size"></p>
                                </div>
                                <div id="upload-progress" class="hidden mt-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Enviando...</span>
                                        <span id="progress-text">0%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Área de Link -->
                            <div id="link-area" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">URL *</label>
                                <input type="url" id="mat-url" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://...">
                                <p class="text-xs text-gray-500 mt-1">Cole o link do Google Drive, YouTube ou outro site</p>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                            <button onclick="document.getElementById('modal-materiais').remove()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                            <button onclick="app.saveMaterial()" id="btn-save" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Salvar Material</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(div);
                this.loadTurmasSelect();
            },

            async loadTurmasSelect() {
                const turmas = await this.getCollection('turmas');
                const select = document.getElementById('mat-turma');
                
                // Se for professor, filtra só as turmas dele
                if (this.currentUserData.tipo === 'professor') {
                    const minhasTurmas = turmas.filter(t => t.professorId === this.currentUserData.id);
                    minhasTurmas.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.nome;
                        option.dataset.nome = t.nome;
                        select.appendChild(option);
                    });
                } else {
                    turmas.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.nome;
                        option.dataset.nome = t.nome;
                        select.appendChild(option);
                    });
                }
            },

            selectMaterialType(type) {
                this.currentMaterialType = type;
                
                // Atualiza botões visuais
                const types = ['arquivo', 'link', 'youtube'];
                types.forEach(t => {
                    const btn = document.getElementById(`btn-${t}`);
                    if (t === type) {
                        btn.className = 'flex-1 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium text-sm';
                    } else {
                        btn.className = 'flex-1 py-2 border-2 border-gray-200 text-gray-600 rounded-lg text-sm';
                    }
                });
                
                // Mostra/esconde áreas
                if (type === 'arquivo') {
                    document.getElementById('upload-area').classList.remove('hidden');
                    document.getElementById('link-area').classList.add('hidden');
                } else {
                    document.getElementById('upload-area').classList.add('hidden');
                    document.getElementById('link-area').classList.remove('hidden');
                }
                
                // Limpa seleções anteriores
                this.selectedFile = null;
                if (document.getElementById('mat-file')) {
                    document.getElementById('mat-file').value = '';
                }
                if (document.getElementById('file-info')) {
                    document.getElementById('file-info').classList.add('hidden');
                }
            },

            handleFile(input) {
                const file = input.files[0];
                if (!file) return;
                
                // Verifica tamanho (30MB)
                if (file.size > 30 * 1024 * 1024) {
                    alert('Arquivo muito grande! Limite máximo: 30MB\nSeu arquivo tem: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
                    input.value = '';
                    return;
                }
                
                // Verifica extensão
                const allowedTypes = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'png', 'jpg', 'jpeg'];
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(ext)) {
                    alert('Tipo de arquivo não permitido!\n\nPermitidos: PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX, PNG, JPG, JPEG');
                    input.value = '';
                    return;
                }
                
                this.selectedFile = file;
                
                // Mostra informações do arquivo
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                document.getElementById('file-info').classList.remove('hidden');
            },

            async saveMaterial() {
                const titulo = document.getElementById('mat-titulo').value.trim();
                const turmaSelect = document.getElementById('mat-turma');
                const turmaId = turmaSelect.value;
                const turmaNome = turmaSelect.options[turmaSelect.selectedIndex]?.dataset.nome || 'Geral';
                
                if (!titulo || !turmaId) {
                    alert('Preencha o título e selecione a turma!');
                    return;
                }
                
                const btnSave = document.getElementById('btn-save');
                btnSave.disabled = true;
                btnSave.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
                
                try {
                    let url = '';
                    let tipo = this.currentMaterialType;
                    let fileName = '';
                    
                    if (tipo === 'arquivo') {
                        if (!this.selectedFile) {
                            alert('Selecione um arquivo!');
                            btnSave.disabled = false;
                            btnSave.textContent = 'Salvar Material';
                            return;
                        }
                        
                        // Prepara o upload
                        const ext = this.selectedFile.name.split('.').pop().toLowerCase();
                        const timestamp = Date.now();
                        const fileNameStorage = `materiais/${turmaId}/${timestamp}_${this.selectedFile.name}`;
                        
                        const fileRef = storage.ref().child(fileNameStorage);
                        const uploadTask = fileRef.put(this.selectedFile);
                        
                        // Mostra progresso
                        document.getElementById('upload-progress').classList.remove('hidden');
                        
                        // Monitora progresso
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                document.getElementById('progress-bar').style.width = progress + '%';
                                document.getElementById('progress-text').textContent = Math.round(progress) + '%';
                            },
                            (error) => {
                                console.error('Erro upload:', error);
                                alert('Erro ao enviar arquivo: ' + error.message);
                                btnSave.disabled = false;
                                btnSave.textContent = 'Salvar Material';
                                document.getElementById('upload-progress').classList.add('hidden');
                            },
                            async () => {
                                // Upload completo
                                url = await uploadTask.snapshot.ref.getDownloadURL();
                                fileName = this.selectedFile.name;
                                
                                // Salva no Firestore
                                await this.saveToFirestore({
                                    titulo,
                                    turmaId,
                                    turmaNome,
                                    tipo: ext,
                                    url,
                                    fileName,
                                    professorId: this.currentUserData.id,
                                    professorNome: this.currentUserData.nome,
                                    tamanho: this.selectedFile.size,
                                    criado: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        );
                        return; // Sai da função pois o resto é feito no callback acima
                        
                    } else {
                        // Link ou YouTube
                        url = document.getElementById('mat-url').value.trim();
                        
                        if (!url) {
                            alert('Informe a URL!');
                            btnSave.disabled = false;
                            btnSave.textContent = 'Salvar Material';
                            return;
                        }
                        
                        // Valida URL YouTube
                        if (tipo === 'youtube') {
                            if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                                alert('URL do YouTube inválida!');
                                btnSave.disabled = false;
                                btnSave.textContent = 'Salvar Material';
                                return;
                            }
                        }
                        
                        await this.saveToFirestore({
                            titulo,
                            turmaId,
                            turmaNome,
                            tipo,
                            url,
                            professorId: this.currentUserData.id,
                            professorNome: this.currentUserData.nome,
                            criado: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                } catch (err) {
                    console.error(err);
                    alert('Erro ao salvar: ' + err.message);
                    btnSave.disabled = false;
                    btnSave.textContent = 'Salvar Material';
                }
            },

            async saveToFirestore(data) {
                try {
                    await db.collection('materiais').add(data);
                    this.showToast('Material adicionado com sucesso!', 'success');
                    document.getElementById('modal-materiais').remove();
                    this.renderContent();
                } catch (err) {
                    alert('Erro ao salvar no banco: ' + err.message);
                    document.getElementById('btn-save').disabled = false;
                    document.getElementById('btn-save').textContent = 'Salvar Material';
                }
            },

            async getCollection(collection) {
                const snapshot = await db.collection(collection).get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const color = type === 'success' ? 'bg-blue-600' : 'bg-red-500';
                toast.className = `${color} text-white px-6 py-3 rounded-lg shadow-lg mb-2 fade-in`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        app.init();
    </script>
</body>
</html>
