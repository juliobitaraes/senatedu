<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENATEDU - Sistema de Gestão Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background-color: #dcfce7; color: #166534; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <div id="app"></div>

    <script>
        // ==================== CONFIGURAÇÃO FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyChnKOxAQH9RqSYmvcf3zYmajg3p5LCogc",
            authDomain: "educloud-sistema.firebaseapp.com",
            projectId: "educloud-sistema",
            storageBucket: "educloud-sistema.firebasestorage.app",
            messagingSenderId: "279645366191",
            appId: "1:279645366191:web:df16df577ccc959a4f315a"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const app = {
            currentUser: null,
            currentUserData: null,
            currentView: 'dashboard',
            currentMaterialType: 'arquivo',
            tempQuestoes: [],
            provaTimer: null,
            
            init() {
                this.monitorAuth();
            },

            monitorAuth() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const doc = await db.collection('users').doc(user.uid).get();
                            if (doc.exists) {
                                this.currentUser = user;
                                this.currentUserData = { id: user.uid, ...doc.data() };
                                this.renderMainLayout();
                            } else {
                                auth.signOut();
                            }
                        } catch (e) {
                            console.error("Erro auth", e);
                            this.renderLogin();
                        }
                    } else {
                        this.renderLogin();
                    }
                });
            },

            // ==================== LOGIN & LAYOUT ====================

            renderLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-800 via-blue-600 to-blue-500 p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 space-y-6 fade-in">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-700 to-blue-500 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
                                    <i class="fas fa-graduation-cap text-3xl text-white"></i>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-900">SENATEDU</h1>
                                <p class="text-gray-500">Sistema de Gestão Escolar</p>
                            </div>
                            <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center"></div>
                            <form id="login-form" class="space-y-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin@escola.com"></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Senha</label><input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••"></div>
                                <button type="submit" id="login-btn" class="w-full bg-blue-700 text-white py-2 rounded-lg font-semibold hover:bg-blue-800 transition"><span id="btn-text">Entrar</span></button>
                            </form>
                            <div class="text-center text-sm"><button onclick="app.setupFirstAdmin()" class="text-blue-600 hover:underline font-medium">Criar conta de Administrador</button></div>
                        </div>
                    </div>`;
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const btnText = document.getElementById('btn-text');
                    btnText.innerHTML = '<div class="loading"></div>';
                    try { await auth.signInWithEmailAndPassword(email, password); } 
                    catch (err) { document.getElementById('login-error').textContent = 'Email ou senha incorretos'; document.getElementById('login-error').classList.remove('hidden'); btnText.textContent = 'Entrar'; }
                });
            },

            async setupFirstAdmin() {
                const nome = prompt('Digite seu nome completo:');
                const email = prompt('Digite seu email:');
                const senha = prompt('Crie uma senha (min 6 chars):');
                if (!nome || !email || !senha) return;
                try {
                    const userCred = await auth.createUserWithEmailAndPassword(email, senha);
                    await db.collection('users').doc(userCred.user.uid).set({ nome: nome, email: email, tipo: 'admin', criado: firebase.firestore.FieldValue.serverTimestamp() });
                    alert('Admin criado!');
                } catch (err) { alert('Erro: ' + err.message); }
            },

            logout() { auth.signOut(); },

            renderMainLayout() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex flex-col md:flex-row">
                        <aside id="sidebar" class="bg-slate-900 text-white w-64 flex-shrink-0 fixed h-screen overflow-y-auto z-30 hidden md:block">
                            <div class="p-6 border-b border-slate-800">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-400 rounded-lg flex items-center justify-center"><i class="fas fa-graduation-cap text-lg"></i></div>
                                    <div><h1 class="text-xl font-bold">SENATEDU</h1><p class="text-xs text-slate-400">${this.capitalize(this.currentUserData.tipo)}</p></div>
                                </div>
                            </div>
                            <nav class="p-4 space-y-2" id="sidebar-nav"></nav>
                            <div class="absolute bottom-0 w-full p-4 border-t border-slate-800 bg-slate-900">
                                <button onclick="app.logout()" class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition text-sm"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
                            </div>
                        </aside>
                        <main class="flex-1 md:ml-64 min-h-screen">
                            <div class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-10">
                                <button onclick="document.getElementById('sidebar').classList.toggle('hidden')" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                                <span class="font-semibold text-blue-800">SENATEDU</span>
                                <div class="w-8"></div>
                            </div>
                            <div id="content-area" class="p-4 md:p-8 fade-in"></div>
                        </main>
                    </div>`;
                this.renderSidebar();
                this.renderContent();
            },

            renderSidebar() {
                const nav = document.getElementById('sidebar-nav');
                const type = this.currentUserData.tipo;
                const menus = {
                    admin: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'turmas', icon: 'fa-chalkboard', label: 'Turmas' },
                        { id: 'professores', icon: 'fa-chalkboard-teacher', label: 'Professores' }, 
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Alunos' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' },
                        { id: 'provas', icon: 'fa-file-signature', label: 'Provas' }
                    ],
                    professor: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'alunos', icon: 'fa-user-graduate', label: 'Meus Alunos' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' },
                        { id: 'provas', icon: 'fa-file-signature', label: 'Provas' }
                    ],
                    aluno: [
                        { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
                        { id: 'materiais', icon: 'fa-book', label: 'Materiais' },
                        { id: 'provas', icon: 'fa-file-signature', label: 'Provas' }
                    ]
                };
                nav.innerHTML = (menus[type] || []).map(item => `
                    <button onclick="app.navigate('${item.id}')" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition ${this.currentView === item.id ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                        <i class="fas ${item.icon} w-5"></i><span>${item.label}</span>
                    </button>`).join('');
            },

            navigate(view) {
                this.currentView = view;
                this.renderSidebar();
                this.renderContent();
                if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            },

            async renderContent() {
                const content = document.getElementById('content-area');
                content.innerHTML = '<div class="flex justify-center mt-10"><div class="loading border-blue-600 border-t-transparent w-10 h-10 border-4"></div></div>';
                
                try {
                    // Roteamento
                    if (this.currentView === 'dashboard') await this.renderDashboard(content);
                    else if (this.currentView === 'materiais') await this.renderMateriais(content);
                    else if (this.currentView === 'provas') await this.renderProvas(content);
                    else if (this.currentView === 'turmas' && this.currentUserData.tipo === 'admin') await this.renderTurmas(content);
                    else if (this.currentView === 'professores' && this.currentUserData.tipo === 'admin') await this.renderProfessores(content);
                    else if (this.currentView === 'alunos') await this.renderAlunos(content);
                    else content.innerHTML = '<div class="text-center text-gray-500">Acesso restrito ou não encontrado.</div>';
                } catch (error) {
                    console.error("Erro na renderização:", error);
                    content.innerHTML = `<div class="text-center text-red-500">Erro ao carregar tela: ${error.message}</div>`;
                }
            },

            // ==================== DASHBOARD ====================
            async renderDashboard(container) {
                if (this.currentUserData.tipo !== 'aluno') {
                    const turmas = (await this.getCollection('turmas'));
                    let minhasTurmas = turmas;
                    if(this.currentUserData.tipo === 'professor') {
                         minhasTurmas = turmas.filter(t => t.professores && t.professores.includes(this.currentUserData.id));
                    }

                    container.innerHTML = `
                        <div class="mb-6"><h2 class="text-2xl font-bold text-gray-800">Resultados e Diário</h2></div>
                        ${minhasTurmas.length === 0 ? '<p class="text-gray-500">Nenhuma turma vinculada.</p>' : ''}
                        ${minhasTurmas.map(t => `<div id="dash-turma-${t.id}" class="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 p-4"><div class="loading"></div></div>`).join('')}
                    `;
                    for (const t of minhasTurmas) this.renderTurmaResultados(t.id, t.nome);
                } else {
                    app.navigate('provas');
                }
            },

            async renderTurmaResultados(turmaId, turmaNome) {
                const provas = (await this.getCollection('provas')).filter(p => p.turmaId === turmaId);
                const alunos = (await this.getCollection('users')).filter(u => u.tipo === 'aluno');
                const turmaDoc = await db.collection('turmas').doc(turmaId).get();
                const alunosDaTurmaIds = turmaDoc.data()?.alunos || [];
                const alunosDaTurma = alunos.filter(a => alunosDaTurmaIds.includes(a.id));
                const resultados = await this.getCollection('provas_resultados');

                let html = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-blue-900">${turmaNome}</h3>
                        <span class="text-sm text-gray-500">${provas.length} Provas | ${alunosDaTurma.length} Alunos</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3">Aluno</th>
                                    ${provas.map(p => `<th class="p-3 text-center min-w-[120px]">${p.titulo}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${alunosDaTurma.map(aluno => {
                                    return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 font-medium text-gray-900">${aluno.nome}</td>
                                        ${provas.map(p => {
                                            const res = resultados.find(r => r.provaId === p.id && r.alunoId === aluno.id);
                                            if(!res) return `<td class="p-3 text-center text-gray-300">-</td>`;
                                            const nota = parseFloat(res.nota);
                                            const color = nota >= 60 ? 'text-green-600' : 'text-red-600';
                                            return `<td class="p-3 text-center font-bold ${color}">${nota}</td>`;
                                        }).join('')}
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex gap-2 justify-end">
                        <button onclick="app.exportarResultadosExcel('${turmaId}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                            <i class="fas fa-file-excel mr-1"></i> Exportar
                        </button>
                    </div>
                `;
                document.getElementById(`dash-turma-${turmaId}`).innerHTML = html;
            },

            // ==================== ALUNOS ====================
            async renderAlunos(container) {
                const turmas = await this.getCollection('turmas');
                let alunos = (await this.getCollection('users')).filter(u => u.tipo === 'aluno');
                
                if (this.currentUserData.tipo === 'professor') {
                    const minhasTurmasIds = turmas.filter(t => t.professores?.includes(this.currentUserData.id)).map(t => t.id);
                    alunos = alunos.filter(a => turmas.some(t => minhasTurmasIds.includes(t.id) && t.alunos && t.alunos.includes(a.id)));
                }

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Gerenciar Alunos</h2>
                        <button onclick="app.modalAluno()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800">
                            <i class="fas fa-plus mr-2"></i>Novo Aluno
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-800 border-b">
                                <tr>
                                    <th class="p-4">Nome</th>
                                    <th class="p-4">Email</th>
                                    <th class="p-4">Turmas</th>
                                    <th class="p-4 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${alunos.map(a => {
                                    const turmasAluno = turmas.filter(t => t.alunos && t.alunos.includes(a.id)).map(t => t.nome).join(', ');
                                    return `
                                    <tr class="hover:bg-gray-50 group">
                                        <td class="p-4 font-medium text-gray-900">${a.nome}</td>
                                        <td class="p-4">${a.email}</td>
                                        <td class="p-4"><span class="badge badge-blue">${turmasAluno || 'Nenhuma'}</span></td>
                                        <td class="p-4 text-right">
                                            <button onclick="app.modalAluno('${a.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                                            ${this.currentUserData.tipo === 'admin' ? `<button onclick="app.deleteUsuario('${a.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            async modalAluno(id = null) {
                const turmas = await this.getCollection('turmas');
                let aluno = null; let turmasDoAluno = [];
                if (id) { const doc = await db.collection('users').doc(id).get(); aluno = { id: doc.id, ...doc.data() }; turmasDoAluno = turmas.filter(t => t.alunos && t.alunos.includes(id)).map(t => t.id); }
                
                const content = `
                    <div class="space-y-3">
                        ${!id ? `<div><label class="block text-sm font-medium mb-1">Email</label><input type="email" id="alu-email" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium mb-1">Senha</label><input type="password" id="alu-pass" class="w-full px-4 py-2 border rounded-lg"></div>` : ''}
                        <div><label class="block text-sm font-medium mb-1">Nome</label><input type="text" id="alu-nome" value="${aluno ? aluno.nome : ''}" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium mb-1">Turmas</label><div class="max
